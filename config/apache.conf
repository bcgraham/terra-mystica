Listen 80
Listen 3030
User daemon
Group daemon
<VirtualHost *:80>
    ServerName localhost:80
    ProxyPass / http://localhost:3030/
    ProxyPassReverse / http://localhost:3030/
</VirtualHost>
<VirtualHost *:3030>
    ServerName localhost:3030
    DocumentRoot /terra-mystica/www-docker/
    #LoadModule mpm_prefork_module 
    #LoadModule rewrite_module mod_rewrite.so
    #LoadModule mime_module mod_mime.so
    #LoadModule headers_module mod_headers.so
    LoadModule fastcgi_module /usr/local/apache2/modules/mod_fastcgi.so
    AddDefaultCharset utf-8

    <Proxy *>
        Order deny,allow
        Allow from all 
    </Proxy>

    RewriteEngine on

    RewriteRule ^(/stc/.*)$ $1 [L]
    RewriteRule ^(/data/.*)$ $1 [L]
    RewriteRule ^/validate/(.*)$ /app/register/validate/$1 [P]
    RewriteRule ^/validate-alias/(.*)$ /app/alias/validate/$1 [P]
    RewriteRule ^/validate-reset/(.*)$ /app/reset/validate/$1 [P]
    RewriteRule ^/((app)/(.*))?$ /$1 [L,PT]

    # RewriteRule ^/down.html$ /down.html [L]
    # RewriteRule ^(|/|.*) /down.html [R=307,L]
    # RewriteRule ^(|/|/index.html)$ /down.html [P]

    RewriteRule ^/(([a-z]+)/(.*))?$ /app/template/$1 [P]
    RewriteRule ^(|/|/index.html)$ /app/template/index [P]

    Options -Indexes +SymLinksIfOwnerMatch

    <Directory "/terra-mystica/www-docker/">
        Order allow,deny
        Allow from all
    </Directory>
    
    AddType application/json .json
    <Location "/stc">
       Header add "Cache-Control" "public, max-age=864000"
    </Location>

    FastCgiServer /terra-mystica/www-docker/lib/app.fcgi -initial-env ENV=prod -processes 5
    ScriptAlias /app/ "/terra-mystica/www-docker/lib/app.fcgi/"

    ScriptLog /terra-mystica/logs/terra-debug.log
    ErrorLog /terra-mystica/logs/terra-error.log
    LogLevel warn
    CustomLog /terra-mystica/logs/terra-access.log combined

    CustomLog /terra-mystica/logs/terra-timing.log "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\" %Dusec"
    
</VirtualHost>
